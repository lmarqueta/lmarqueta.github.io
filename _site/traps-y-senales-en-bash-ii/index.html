<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Traps y señales en bash (II) &#8211; Out of memory</title>
<meta name="description" content="segunda parte del artículo sobre señales en bash">
<meta name="keywords" content="bash, shell, traps">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Traps y señales en bash (II)">
<meta name="twitter:description" content="segunda parte del artículo sobre señales en bash">
<meta name="twitter:site" content="@lmarqueta">
<meta name="twitter:creator" content="@lmarqueta">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="es_ES">
<meta property="og:type" content="article">
<meta property="og:title" content="Traps y señales en bash (II)">
<meta property="og:description" content="segunda parte del artículo sobre señales en bash">
<meta property="og:url" content="http://localhost:4000/traps-y-senales-en-bash-ii/">
<meta property="og:site_name" content="Out of memory">





<link rel="canonical" href="http://localhost:4000/traps-y-senales-en-bash-ii/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Out of memory Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/" >Home</a></li>
		  
		    
		    <li><a href="http://localhost:4000/code/" >#!</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="http://localhost:4000/" class="site-logo" rel="home" title="Out of memory"><img src="http://localhost:4000/images/site-logo.png" width="200" height="200" alt="Out of memory logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">Out of memory</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Como si no tuviera otra cosa que hacer</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        
          <h1 class="entry-title">Traps y señales en bash (II)</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/tux-skull.png" class="bio-photo" alt="outofmemory.es bio photo"></a>
        
        <span class="author vcard">By <span class="fn">outofmemory.es</span></span>
        <span class="entry-date date published"><time datetime="2013-11-22T00:00:00+01:00"><i class="fa fa-calendar-o"></i> November 22, 2013</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=bash,shell,traps&amp;text=Traps%20y%20señales%20en%20bash%20(II)&amp;url=http://localhost:4000/traps-y-senales-en-bash-ii/&amp;via=lmarqueta" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/traps-y-senales-en-bash-ii/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=http://localhost:4000/traps-y-senales-en-bash-ii/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>Continuando con el artículo anterior, vamos a ver un ejemplo de cómo impedir la ejecución de varias instancias de un script.</p>

<p>Sea este complejísimo script, que cuenta de 1 en 1 hasta 10:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/bash</span>
<span class="nv">i</span><span class="o">=</span>1
<span class="k">while</span> <span class="o">[</span> <span class="nv">$i</span> -le 10 <span class="o">]</span>; <span class="k">do
 </span><span class="nb">echo</span> <span class="nv">$i</span>
 <span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
 sleep 1
<span class="k">done</span></code></pre></figure>

<p>Evidentemente, no hay problema en ejecutarlo tantas veces como sea posible de forma concurrente. Por ejemplo:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./nobloqueo.sh &amp; ./nobloqueo.sh
<span class="o">[</span>1] 19585
1
1
2
2
3
3
^C</code></pre></figure>

<p>Uf, qué lío. Así no hay quien aprenda a contar. Sería mucho mejor impedir que el script se ejecutase más de una vez. Para ello, el método “clásico” es escribir un fichero de “lock”. Si el fichero existe, no me ejecuto; si no existe, lo escribo, me ejecuto, y lo borro después, para dejar que otro usuario pueda ejecutarlo. Hágase:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat bloqueo.sh
<span class="c">#!/bin/bash</span>
<span class="nv">LOCK</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/bloqueo.lck"</span>
<span class="c"># Si no existe el fichero, lo escribo y me ejecuto:</span>
<span class="k">if</span> <span class="o">[</span> ! -e <span class="nv">$LOCK</span> <span class="o">]</span>; <span class="k">then
 </span>touch <span class="nv">$LOCK</span>
 <span class="nv">i</span><span class="o">=</span>1
 <span class="k">while</span> <span class="o">[</span> <span class="nv">$i</span> -le 10 <span class="o">]</span>; <span class="k">do
 </span><span class="nb">echo</span> <span class="nv">$i</span>
 <span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
 sleep 1
 <span class="k">done</span>
 /bin/rm <span class="nv">$LOCK</span>
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"Ya estoy contando hasta 10"</span>
<span class="k">fi</span></code></pre></figure>

<p>Si el fichero bloqueo.lck no existe, se creará y comenzará la cuenta; pero si existe dicho fichero, el script se quejará y no contará nada. Para probarlo, ejecuto el script en un terminal…</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./bloqueo.sh
1
2
3</code></pre></figure>

<p>y, mientras, corre, me voy a otro terminal a tratar de ejecutarlo de nuevo:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./bloqueo.sh
Ya estoy contando hasta 10</code></pre></figure>

<p>¿Correcto? ¡¡Pues no, muy mal!! Aquí se da lo que se conoce como <em>race condition</em>; y es que en el intervalo entre que se chequea la existencia del fichero y se crea este, es posible que otro script empiece a ejecutarse y se venga abajo todo nuestro tinglado. Claro, la operación no es atómica. ¿No crees que sea posible? Mira qué fácil:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./bloqueo.sh &amp; ./bloqueo.sh
<span class="o">[</span>1] 20099
1
1
2
2
3
3
4
4</code></pre></figure>

<p>Bash ofrece un mecanismo que sirve de ayuda para estos casos: la opción noclobber. Veamos qué dice man bash:</p>

<blockquote>
  <table>
    <tbody>
      <tr>
        <td>If the redirection operator is &gt;, and the noclobber option to the set builtin has been enabled, the redirection will fail if the file whose name results from the expansion of word exists and is a regular file. If the redirection operator is &gt;</td>
        <td>, or the redirection operator is &gt; and the noclobber option to the set builtin command is not enabled, the redirection is attempted even if the file named by word exists.</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<p>Vamos, que si está establecido noclobber y se usa el operador de redirección &gt;, esta fallará si el fichero existe. Probemos así entonces:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat bloqueo2.sh
<span class="c">#!/bin/bash</span>
<span class="nv">LOCK</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/bloqueo.lck"</span>
<span class="c"># Si no existe el fichero, lo escribo y me ejecuto:</span>
<span class="k">if</span> <span class="o">(</span> <span class="nb">set</span> -o noclobber; <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$$</span><span class="s2">"</span> &gt; <span class="s2">"</span><span class="nv">$LOCK</span><span class="s2">"</span><span class="o">)</span> 2&gt; /dev/null; <span class="k">then
 </span><span class="nv">i</span><span class="o">=</span>1
 <span class="k">while</span> <span class="o">[</span> <span class="nv">$i</span> -le 10 <span class="o">]</span>; <span class="k">do
 </span><span class="nb">echo</span> <span class="nv">$i</span>
 <span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
 sleep 1
 <span class="k">done</span>
 /bin/rm <span class="nv">$LOCK</span>
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"Ya estoy contando hasta 10"</span>
<span class="k">fi</span></code></pre></figure>

<p>Y probando a ejecutarlo como antes:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./bloqueo2.sh &amp; ./bloqueo2.sh
<span class="o">[</span>1] 20178
1
Ya estoy contando hasta 10
<span class="gp">$ </span>2
3
4
5</code></pre></figure>

<p>Vemos como, efectivamente, uno de los dos scripts falla.</p>

<p>Si nos cansamos de ver cómo cuenta el script y lo interrumpimos (Ctrl+C), ¿qué es lo que ocurrirá? Que la siguiente vez que queramos lanzarlo no podremos, porque nos habremos dejado colgando el fichero de lock. Así que, poniendo en práctica lo visto en el artículo referenciado arriba, podemos hacer esto:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat bloqueo3.sh
<span class="c">#!/bin/bash</span>
<span class="nv">LOCK</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/bloqueo.lck"</span>
<span class="nb">trap</span> <span class="s1">'rm -f "$LOCK"; exit'</span> INT TERM EXIT ERR
<span class="c"># Si no existe el fichero, lo escribo y me ejecuto:</span>
<span class="k">if</span> <span class="o">(</span> <span class="nb">set</span> -o noclobber; <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$$</span><span class="s2">"</span> &amp; <span class="s2">"</span><span class="nv">$LOCK</span><span class="s2">"</span><span class="o">)</span> 2&gt; /dev/null; <span class="k">then
 </span><span class="nv">i</span><span class="o">=</span>1
 <span class="k">while</span> <span class="o">[</span> <span class="nv">$i</span> -le 10 <span class="o">]</span>; <span class="k">do
 </span><span class="nb">echo</span> <span class="nv">$i</span>
 <span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
 sleep 1
 <span class="k">done</span>
 /bin/rm <span class="nv">$LOCK</span>
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"Ya estoy contando hasta 10"</span>
<span class="k">fi</span></code></pre></figure>

<p>¿Mejor, no? ¡¡Pues no!! ¡¡Muchísimo peor!! Definiendo así el trap, un segundo script que se ejecutara no contaría, pero borraría el fichero de lock, permitiendo que se ejecutase un tercer script. La mejor alternativa sería esta:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat ./bloqueo2.sh
<span class="c">#!/bin/bash</span>
<span class="nv">LOCK</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/bloqueo.lck"</span>
<span class="c"># Si no existe el fichero, lo escribo y me ejecuto:</span>
<span class="k">if</span> <span class="o">(</span> <span class="nb">set</span> -o noclobber; <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$$</span><span class="s2">"</span> &amp; <span class="s2">"</span><span class="nv">$LOCK</span><span class="s2">"</span><span class="o">)</span> 2&gt; /dev/null; <span class="k">then
 </span><span class="nb">trap</span> <span class="s1">'rm -f "$LOCK"; exit'</span> INT TERM EXIT ERR
 <span class="nv">i</span><span class="o">=</span>1
 <span class="k">while</span> <span class="o">[</span> <span class="nv">$i</span> -le 10 <span class="o">]</span>; <span class="k">do
 </span><span class="nb">echo</span> <span class="nv">$i</span>
 <span class="nv">i</span><span class="o">=</span><span class="k">$((</span>i+1<span class="k">))</span>
 sleep 1
 <span class="k">done</span>
 /bin/rm <span class="nv">$LOCK</span>
 <span class="nb">trap</span> - INT TERM EXIT ERR
<span class="k">else
 </span><span class="nb">echo</span> <span class="s2">"Ya estoy contando hasta 10"</span>
<span class="k">fi</span></code></pre></figure>

<p>De esta forma, en el momento en que el script falla aún no se han redefinido los traps y el fichero .lck no se borra.</p>

<p>Aun así, no estaría de más comprobar antes de borrar el fichero de lock que realmente ha sido escrito por mí (de ahí que se escriba el pid en el fichero). Pero bueno, eso ya es segundo de bash</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lmarqueta-github-io'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
        <ul class="entry-tags">
          <li><a href="http://localhost:4000/tags/#bash" title="Pages tagged bash">bash</a></li><li><a href="http://localhost:4000/tags/#shell" title="Pages tagged shell">shell</a></li><li><a href="http://localhost:4000/tags/#traps" title="Pages tagged traps">traps</a></li>
        </ul>
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/traps-y-senales-en-bash-i/" class="btn" title="Traps y señales en bash (I)">Previous</a>
      
      
        <a href="http://localhost:4000/magic-sys-req-thinkpad/" class="btn" title="Magic SysRq en un Lenovo ThinkPad Edge">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2016 outofmemory.es. b3V0IG9mIG1lbW9yeQ== Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/lmarqueta" title="outofmemory.es on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	<a href="https://plus.google.com/+LuisMarqueta" title="outofmemory.es on Google+" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
	
	
	
	
	<a href="https://github.com/lmarqueta" title="outofmemory.es on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-88580921-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>
