<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Traps y señales en bash (I) &#8211; Out of memory</title>
<meta name="description" content="Manejo básico de señales en la shell">
<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Traps y señales en bash (I)">
<meta name="twitter:description" content="Manejo básico de señales en la shell">
<meta name="twitter:site" content="@lmarqueta">
<meta name="twitter:creator" content="@lmarqueta">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://localhost:4000/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="es_ES">
<meta property="og:type" content="article">
<meta property="og:title" content="Traps y señales en bash (I)">
<meta property="og:description" content="Manejo básico de señales en la shell">
<meta property="og:url" content="http://localhost:4000/traps-y-senales-en-bash-i/">
<meta property="og:site_name" content="Out of memory">





<link rel="canonical" href="http://localhost:4000/traps-y-senales-en-bash-i/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Out of memory Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://localhost:4000/" >Home</a></li>
		  
		    
		    <li><a href="http://localhost:4000/code/" >#!</a></li>
		  
		    
		    <li><a href="http://localhost:4000/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://localhost:4000/search/" >Search</a></li>
		  
		    
		    <li><a href="http://localhost:4000/about/" >About</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="http://localhost:4000/" class="site-logo" rel="home" title="Out of memory"><img src="http://localhost:4000/images/site-logo.png" width="200" height="200" alt="Out of memory logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="http://localhost:4000/">Out of memory</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">Como si no tuviera otra cosa que hacer</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        
          <h1 class="entry-title">Traps y señales en bash (I)</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://localhost:4000/images/tux-skull.png" class="bio-photo" alt="outofmemory.es bio photo"></a>
        
        <span class="author vcard">By <span class="fn">outofmemory.es</span></span>
        <span class="entry-date date published"><time datetime="2013-11-21T00:00:00+01:00"><i class="fa fa-calendar-o"></i> November 21, 2013</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=&amp;text=Traps%20y%20señales%20en%20bash%20(I)&amp;url=http://localhost:4000/traps-y-senales-en-bash-i/&amp;via=lmarqueta" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/traps-y-senales-en-bash-i/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=http://localhost:4000/traps-y-senales-en-bash-i/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>Algunos  problemas típicos a la hora de crear scripts en bash son estos:</p>

<ul>
  <li>Crear ficheros de lock para, por ejemplo, evitar la ejecución de más de una instancia del script</li>
  <li>Hacer limpieza de ficheros temporales si el script acaba inesperadamente</li>
</ul>

<p>Estos y muchos más que no se me ocurren ahora se pueden resolver gracias al <em>built-in</em> <code class="highlighter-rouge">trap</code>. Este comando permite capturar ciertas señales y definir la acción que se realiza cuando son recibidas por el programa.</p>

<p>Obviamente, hay ciertas señales que no se pueden redefinir como son:</p>

<div class="highlighter-rouge"><pre class="highlight"><code> 9) SIGKILL
18) SIGCONT
19) SIGSTOP
</code></pre>
</div>

<p>La lista se puede ver con el comando:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span><span class="nb">kill</span> -l
 1<span class="o">)</span> SIGHUP   2<span class="o">)</span> SIGINT   3<span class="o">)</span> SIGQUIT  4<span class="o">)</span> SIGILL   5<span class="o">)</span> SIGTRAP
 6<span class="o">)</span> SIGABRT  7<span class="o">)</span> SIGBUS   8<span class="o">)</span> SIGFPE   9<span class="o">)</span> SIGKILL 10<span class="o">)</span> SIGUSR1
11<span class="o">)</span> SIGSEGV 12<span class="o">)</span> SIGUSR2 13<span class="o">)</span> SIGPIPE 14<span class="o">)</span> SIGALRM 15<span class="o">)</span> SIGTERM
16<span class="o">)</span> SIGSTKFLT   17<span class="o">)</span> SIGCHLD 18<span class="o">)</span> SIGCONT 19<span class="o">)</span> SIGSTOP 20<span class="o">)</span> SIGTSTP
21<span class="o">)</span> SIGTTIN 22<span class="o">)</span> SIGTTOU 23<span class="o">)</span> SIGURG  24<span class="o">)</span> SIGXCPU 25<span class="o">)</span> SIGXFSZ
26<span class="o">)</span> SIGVTALRM   27<span class="o">)</span> SIGPROF 28<span class="o">)</span> SIGWINCH    29<span class="o">)</span> SIGIO   30<span class="o">)</span> SIGPWR
31<span class="o">)</span> SIGSYS  34<span class="o">)</span> SIGRTMIN    35<span class="o">)</span> SIGRTMIN+1  36<span class="o">)</span> SIGRTMIN+2  37<span class="o">)</span> SIGRTMIN+3
38<span class="o">)</span> SIGRTMIN+4  39<span class="o">)</span> SIGRTMIN+5  40<span class="o">)</span> SIGRTMIN+6  41<span class="o">)</span> SIGRTMIN+7  42<span class="o">)</span> SIGRTMIN+8
43<span class="o">)</span> SIGRTMIN+9  44<span class="o">)</span> SIGRTMIN+10 45<span class="o">)</span> SIGRTMIN+11 46<span class="o">)</span> SIGRTMIN+12 47<span class="o">)</span> SIGRTMIN+13
48<span class="o">)</span> SIGRTMIN+14 49<span class="o">)</span> SIGRTMIN+15 50<span class="o">)</span> SIGRTMAX-14 51<span class="o">)</span> SIGRTMAX-13 52<span class="o">)</span> SIGRTMAX-12
53<span class="o">)</span> SIGRTMAX-11 54<span class="o">)</span> SIGRTMAX-10 55<span class="o">)</span> SIGRTMAX-9  56<span class="o">)</span> SIGRTMAX-8  57<span class="o">)</span> SIGRTMAX-7
58<span class="o">)</span> SIGRTMAX-6  59<span class="o">)</span> SIGRTMAX-5  60<span class="o">)</span> SIGRTMAX-4  61<span class="o">)</span> SIGRTMAX-3  62<span class="o">)</span> SIGRTMAX-2
63<span class="o">)</span> SIGRTMAX-1  64<span class="o">)</span> SIGRTMAX</code></pre></figure>

<p>Algunas señales particularmente interesantes para los casos arriba indicados son SIGHUP, SIGINT, SIGQUIT y SIGTERM:</p>

<table>
  <thead>
    <tr>
      <th>Señal</th>
      <th>Descripción</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SIGHUP</td>
      <td>Históricamente era la señal que indicaba que el terminal al otro lado de la línea serie había “colgado”. Actualmente indica que el terminal controller se ha cerrado y suele redefinirse para recargar configuración y reabrir ficheros de log</td>
    </tr>
    <tr>
      <td>SIGINT</td>
      <td>Interrupción, típicamente Ctrl+C en el teclado</td>
    </tr>
    <tr>
      <td>SIGQUIT</td>
      <td>Enviado por el controlling terminal para terminar un programa (¿y generar un core dump?</td>
    </tr>
    <tr>
      <td>SIGTERM</td>
      <td>Similar a SIGINT, indica la terminación de un programa</td>
    </tr>
  </tbody>
</table>

<p>Pues bien, estas señales se pueden capturar, redefinir o ignorar. Por ejemplo, podemos redefinir la acción que se ejecuta por defecto al recibir la señal que se genera al pulsar Ctrl+C  y decidir que, en lugar de terminar el programa, nos muestre un simpático mensaje:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat ctrlc.sh
<span class="c">#!/bin/bash</span>
<span class="nb">trap</span> <span class="s1">'echo "Paso de ti..."'</span> SIGINT
<span class="k">while </span><span class="nb">true</span>; <span class="k">do
 </span>sleep 1
<span class="k">done</span></code></pre></figure>

<p>Si lo ejecutamos y tratamos de interrumpir el programa con Ctrl+C…</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>chmod 755 ctrlc.sh
<span class="gp">$ </span>./ctrlc.sh
^CPaso de ti...
^CPaso de ti...
^CPaso de ti...</code></pre></figure>

<p>Mmmm… ahora, claro, habrá que ingeniárselas para parar el programa de otra forma. Esto quiere decir que hay que ser cuidadoso redefiniendo señales.</p>

<p>El formato del comando trap es el siguiente:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">trap</span> <span class="s1">'lista de comandos'</span> SEÑAL1 <span class="o">[</span>SEÑAL2 ...]</code></pre></figure>

<p>Además, la señal se puede ignorar…</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">trap</span> <span class="s1">''</span> SIGNAL</code></pre></figure>

<p>o resetear a su valor por defecto (definido en signal.h):</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">trap</span> - SIGNAL</code></pre></figure>

<p>Con esto ya podemos ir haciendo cosas; si tenemos un script que genera ficheros temporales que queremos eliminar si termina de forma inesperada, podemos redefinir ciertas señales de este modo:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/bash</span>
<span class="c">#</span>
<span class="c"># Borrar fichero temporal:</span>
<span class="nb">trap</span> <span class="s1">'/bin/rm /tmp/mitemp.$$; exit'</span> SIGHUP SIGINT SIGQUIT SIGTERM</code></pre></figure>

<p>Rizando, el rizo, se podría añadir la pseudoseñal ERR. Si ERR está en la lista de señales, la lista de comandos indicada definida en el trap se ejecutará si se produce un error (código de salida no-cero) en el script, salvo en estas circunstancias:</p>

<ul>
  <li>El comando que ha fallado forma parte de una lista que sigue a <code class="highlighter-rouge">while</code> o <code class="highlighter-rouge">until</code></li>
  <li>Es parte de un test en una sentencia <code class="highlighter-rouge">if</code></li>
  <li>Es parte de una lista de comandos <code class="highlighter-rouge">&amp;&amp;</code> o <code class="highlighter-rouge">||</code></li>
  <li>La salida del comando está invertida via <code class="highlighter-rouge">!</code></li>
</ul>

<p>Así, por ejemplo:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>cat err.sh
<span class="c">#!/bin/bash -e</span>
<span class="c"># Defino el trap</span>
<span class="nb">trap</span> <span class="s1">'echo "Se ha producido un error"'</span> ERR
touch testfile.txt
chmod 444 testfile.txt
<span class="nb">echo</span> <span class="s2">"esto va a fallar"</span> &gt;testfile.txt
<span class="nb">echo</span> <span class="s2">"esto no se va a ejecutar"</span></code></pre></figure>

<p>Cuando se ejecuta ocurre esto:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="gp">$ </span>./err.sh
./err.sh: line 7: testfile.txt: Permission denied
Se ha producido un error</code></pre></figure>

<p>Nótese que, al ejecutarse bash con la opción -e, termina tras el error y no llega a ejecutarse la última línea. Esto me recuerda que algún día habrá que escribir sobre los modificadores de bash, esos grandes desconocidos :)</p>

<p>Hay otra pseudoseñal interesante, EXIT, que se dispara cuando el script termina.</p>

<p>Y pensaba terminar con lo de los ficheros de lock, pero se quedará para una segunda parte.</p>

        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'lmarqueta-github-io'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
        <ul class="entry-tags">
          
        </ul>
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://localhost:4000/lector-de-tarjetas/" class="btn" title="Lector de tarjetas">Previous</a>
      
      
        <a href="http://localhost:4000/traps-y-senales-en-bash-ii/" class="btn" title="Traps y señales en bash (II)">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2016 outofmemory.es. b3V0IG9mIG1lbW9yeQ== Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/lmarqueta" title="outofmemory.es on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	<a href="https://plus.google.com/+LuisMarqueta" title="outofmemory.es on Google+" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
	
	
	
	
	<a href="https://github.com/lmarqueta" title="outofmemory.es on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://localhost:4000';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-88580921-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



</body>
</html>
